<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Prevent Caching -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Series Config Editor (Level Details)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f4f6f8;
            padding: 20px;
            max-width: 950px;
            margin: 0 auto;
            color: #333;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }

        .container {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
        }

        /* --- Layout & Sticky Header --- */
        .sticky-tools {
            position: -webkit-sticky;
            position: sticky;
            top: 0;
            z-index: 1000;
            background-color: white;
            padding: 15px 20px 5px 20px;
            margin: -25px -25px 20px -25px;
            /* Counteract container padding */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid #eee;
        }

        .file-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            /* removed padding/border here as sticky container handles it */
            flex-wrap: wrap;
            gap: 10px;
        }

        .header-row-right {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        /* Fixed File Info Panel (Top Left) */
        .file-info-panel {
            position: absolute;
            top: 10px;
            left: 15px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 12px;
            color: #555;
            z-index: 10;
        }

        .path-display {
            background: rgba(255, 255, 255, 0.8);
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #eee;
            max-width: 400px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .path-display.active {
            color: #2c3e50;
            border-color: #bdc3c7;
            background: #fdfdfd;
        }



        .header-row-center {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
            border-top: 1px dashed #eee;
            padding-top: 10px;
        }

        /* --- Form Elements --- */
        .form-group {
            margin-bottom: 18px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #555;
        }

        select,
        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
        }

        select:focus,
        input:focus {
            border-color: #3498db;
            outline: none;
        }

        /* --- Levels List --- */
        .levels-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .levels-wrapper {
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            background: #fafafa;
            padding: 10px;
        }

        .levels-container {
            /* Unlimited Height for Page Scrolling */
            /* No max-height, no overflow-y */
            margin-bottom: 10px;
            padding-right: 5px;
        }

        .level-item {
            background: white;
            border: 1px solid #d1d5da;
            border-radius: 4px;
            margin-bottom: 6px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.2s;
        }

        .level-item:hover {
            background-color: #f8faff;
            border-color: #3498db;
        }

        .level-content {
            display: flex;
            align-items: center;
            flex: 1;
            cursor: grab;
            overflow: hidden;
        }

        .level-content:active {
            cursor: grabbing;
        }

        .level-index {
            color: #aaa;
            font-size: 12px;
            margin-right: 12px;
            width: 25px;
            flex-shrink: 0;
            user-select: none;
        }

        .level-text-group {
            display: flex;
            align-items: baseline;
            gap: 10px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .level-id {
            font-weight: 600;
            color: #2c3e50;
        }

        .level-name {
            font-size: 0.9em;
            color: #27ae60;
            background: #e8f5e9;
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* --- Item Actions --- */
        .level-actions {
            display: flex;
            gap: 5px;
            flex-shrink: 0;
            margin-left: 10px;
        }

        .btn-icon {
            width: 28px;
            height: 28px;
            border: 1px solid #ddd;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            transition: all 0.2s;
        }

        .btn-icon:hover {
            background: #eee;
        }

        .btn-icon.delete:hover {
            background: #fff5f5;
            border-color: #ffcdd2;
            color: #e74c3c;
        }

        .btn-icon.info {
            color: #3498db;
            border-color: #aed6f1;
        }

        .btn-icon.info:hover {
            background-color: #ebf5fb;
        }

        /* --- Main Buttons --- */
        .btn {
            border: 1px solid #ccc;
            padding: 6px 14px;
            /* Smaller padding */
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            /* Smaller font */
            font-weight: 500;
            transition: all 0.2s;
            color: #555;
            background-color: white;
            /* Default outline */
        }

        .btn:hover {
            border-color: #3498db;
            color: #3498db;
            background-color: #f0f8ff;
        }

        .btn:disabled {
            border-color: #eee;
            color: #aaa;
            background-color: #f9f9f9;
            cursor: not-allowed;
        }



        /* --- Primary Remote Buttons (Filled) --- */
        .btn-remote-load {
            border: none;
            background-color: #3498db;
            color: white;
            font-weight: bold;
            font-size: 14px;
            padding: 8px 24px;
            box-shadow: 0 2px 5px rgba(52, 152, 219, 0.3);
        }

        .btn-remote-load:hover {
            background-color: #2980b9;
            color: white;
            border-color: transparent;
            transform: translateY(-1px);
        }

        .btn-remote-save {
            border: none;
            background-color: #e74c3c;
            color: white;
            font-weight: bold;
            font-size: 14px;
            padding: 8px 24px;
            box-shadow: 0 2px 5px rgba(231, 76, 60, 0.3);
            animation: none;
        }

        .btn-remote-save:hover {
            background-color: #c0392b;
            color: white;
            border-color: transparent;
            transform: translateY(-1px);
        }


        /* --- Primary Remote Buttons --- */
        .btn-remote-load {
            border: none;
            background-color: #3498db;
            color: white;
            font-weight: bold;
            font-size: 14px;
            padding: 8px 24px;
            box-shadow: 0 2px 5px rgba(52, 152, 219, 0.3);
        }

        .btn-remote-load:hover {
            background-color: #2980b9;
            color: white;
            border-color: transparent;
            transform: translateY(-1px);
        }

        .btn-remote-save {
            border: none;
            background-color: #e74c3c;
            color: white;
            font-weight: bold;
            font-size: 14px;
            padding: 8px 24px;
            box-shadow: 0 2px 5px rgba(231, 76, 60, 0.3);
            animation: none;
        }

        .btn-remote-save:hover {
            background-color: #c0392b;
            color: white;
            border-color: transparent;
            transform: translateY(-1px);
        }

        /* Pulsing animation for unsaved changes */
        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(231, 76, 60, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0);
            }
        }

        .btn-remote-save.pulse-anim {
            animation: pulse-red 2s infinite;
        }

        .btn-remote-save:hover {
            background-color: #c0392b;
            transform: translateY(-1px);
        }

        /* --- Float Action Button (Back to Top) --- */
        .fab-top {
            display: none;
            /* Hidden by default */
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 999;
            border: none;
            outline: none;
            background-color: #34495e;
            color: white;
            cursor: pointer;
            padding: 15px;
            border-radius: 50%;
            font-size: 18px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: background-color 0.3s, transform 0.3s;
        }

        .fab-top:hover {
            background-color: #2c3e50;
            transform: scale(1.1);
        }

        /* --- Bulk Edit Area --- */
        .bulk-edit-area {
            display: none;
            margin-top: 15px;
            border-top: 1px dashed #ddd;
            padding-top: 15px;
            background: #fff;
        }

        textarea {
            width: 100%;
            height: 140px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: Consolas, "Courier New", monospace;
            resize: vertical;
            box-sizing: border-box;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 4px;
        }

        .checkbox-wrapper input {
            width: auto;
            margin-right: 10px;
            transform: scale(1.2);
        }

        .checkbox-wrapper label {
            margin: 0;
            font-weight: normal;
            cursor: pointer;
        }

        .checkbox-note {
            display: block;
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .bulk-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* --- Modals (Wiki & Details) Styles --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border: 1px solid #888;
            border-radius: 8px;
            width: 80%;
            max-width: 700px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .close {
            position: absolute;
            right: 20px;
            top: 15px;
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: black;
        }

        /* Wiki Specific */
        .wiki-section {
            margin-bottom: 25px;
        }

        .wiki-section h3 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 2px solid #eee;
            padding-bottom: 8px;
        }

        .wiki-section p,
        .wiki-section li {
            line-height: 1.6;
            color: #444;
        }

        .wiki-tag {
            background: #eee;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
            color: #c0392b;
        }

        /* JSON Details Specific */
        pre.json-display {
            background: #282c34;
            color: #abb2bf;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-family: Consolas, monospace;
            font-size: 14px;
            max-height: 600px;
        }

        .editor-area {
            display: none;
        }

        .config-loaded-indicator {
            color: #27ae60;
            font-size: 0.85em;
            display: none;
            margin-left: 5px;
            font-weight: bold;
        }

        /* --- Focus Mode (Full Screen) --- */
        .focus-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 2000;
            background: white;
            padding: 30px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.3);
        }

        .focus-mode .levels-container {
            max-height: none;
            /* Let flex grow handle it */
            margin-bottom: 20px;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 6px;
            /* Fix for scrolling - Consolidate rules here */
            flex: 1 1 0;
            /* Force basis to 0 to ensure scrolling */
            min-height: 0;
            overflow-y: auto;

            /* Grid Layout */
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 10px;
            align-content: flex-start;
        }

        .focus-mode .levels-header {
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }



        .focus-mode .level-item {
            margin-bottom: 0;
        }

        /* Internal Header for Focus Mode */
        .focus-header {
            display: none;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .focus-mode .focus-header {
            display: flex;
        }

        /* --- V7.11 Card Layout Styles --- */
        .config-card {
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 20px;
            flex-wrap: wrap;
        }

        .config-card.series {
            background-color: #ecf8fe;
            /* Light Blue */
            border-color: #bce0f5;
        }

        .config-card.level {
            background-color: #f5f5f5;
            /* Light Gray */
            border-color: #ddd;
        }

        .card-left {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-tag-required {
            font-size: 12px;
            color: #c0392b;
            font-weight: normal;
            font-style: italic;
        }

        .card-tag-optional {
            font-size: 12px;
            color: #7f8c8d;
            font-weight: normal;
            font-style: italic;
        }

        .file-info-text {
            color: #555;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #ccc;
            display: inline-block;
        }

        .status-dot.active {
            background-color: #27ae60;
        }

        .status-dot.error {
            background-color: #c0392b;
        }

        .status-dot.remote {
            background-color: #27ae60;
        }

        .card-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-end;
        }

        .action-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn-card {
            background-color: white;
            border: 1px solid #dcdcdc;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            color: #333;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .btn-card:hover {
            border-color: #aaa;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-primary-blue {
            background: #3498db;
            color: white;
            border: none;
            box-shadow: 0 2px 5px rgba(52, 152, 219, 0.4);
        }

        .btn-primary-blue:hover {
            background: #2980b9;
            color: white;
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.4);
            transform: translateY(-1px);
        }

        .btn-primary-red {
            background: #e74c3c;
            color: white;
            border: none;
            box-shadow: 0 2px 5px rgba(231, 76, 60, 0.4);
        }

        .btn-primary-red:hover {
            background: #c0392b;
            color: white;
            transform: translateY(-1px);
        }

        .dropdown-btn {
            position: relative;
        }

        .dropdown-btn {
            position: relative;
        }

        /* Sticky State Styles */
        .sticky-tools.is-stuck {
            position: sticky;
            top: 0;
            background: rgba(255, 255, 255, 0.95) !important;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1) !important;
            border-bottom: 1px solid #ddd;
            padding-bottom: 0 !important;
        }

        /* Hide cards when sticky */
        .sticky-tools.is-stuck .config-card {
            display: none;
        }

        /* Adjust Config Controls when sticky */
        .sticky-tools.is-stuck #configControls {
            margin-bottom: 0;
            border: none;
            background: transparent;
            box-shadow: none;
        }
    </style>
</head>

<body>

    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h1>Series Config Editor <span id="appVersion" style="font-size:0.5em; color:#888;"></span></h1>
        <button class="btn btn-outline" onclick="showWiki()" title="Wiki">ğŸ“– å¸®åŠ©æ–‡æ¡£ (Wiki)</button>
    </div>

    <div class="container">
        <div class="sticky-tools" id="stickyHeader"
            style="background:transparent; border:none; box-shadow:none; padding:20px 26px; margin-bottom:10px; z-index: 1000; transition: all 0.3s ease;">

            <!-- Card 1: Series Config -->
            <div class="config-card series">
                <div class="card-left">
                    <h3 class="card-title">Series Config <span class="card-tag-required">(Required)</span></h3>
                    <div class="file-info-text">
                        <span class="status-dot" id="seriesStatusDot"></span>
                        <span id="seriesPathDisplay" title="SeriesCfg è·¯å¾„">æœªåŠ è½½</span>
                    </div>
                </div>
                <div class="card-actions">
                    <div class="action-row">
                        <input type="file" id="fileInput" accept=".json" style="display: none;">
                        <button class="btn-card" onclick="document.getElementById('fileInput').click()">ğŸ“‚
                            æœ¬åœ°åŠ è½½</button>
                        <button class="btn-card" onclick="loadRemoteSeriesConfig()">â˜ï¸ ç½‘ç»œåŠ è½½</button>
                    </div>
                    <div class="action-row">
                        <button class="btn-card btn-primary-blue" id="saveRemoteBtn" onclick="saveToRemote()">ğŸ’¾
                            ä¿å­˜åˆ°ç½‘ç»œ (Save)</button>
                        <div class="dropdown-btn">
                            <button class="btn-card" id="exportBtn" onclick="exportJson()" disabled>ğŸ“¤ å¯¼å‡º
                                JSON</button>
                        </div>
                        <button class="btn-card" id="copyBtn" onclick="copyJson()" disabled title="Copy JSON">ğŸ“‹
                            å¤åˆ¶</button>
                    </div>
                </div>
            </div>

            <!-- Card 2: Level Config -->
            <div class="config-card level">
                <div class="card-left">
                    <h3 class="card-title">Level Config <span class="card-tag-optional">(Optional)</span></h3>
                    <div class="file-info-text">
                        <span class="status-dot" id="levelStatusDot"></span>
                        <span id="levelPathDisplay" title="LevelCfg è·¯å¾„">æœªåŠ è½½ (ä½¿ç”¨é»˜è®¤)</span>
                    </div>
                </div>
                <div class="card-actions">
                    <div class="action-row">
                        <input type="file" id="levelCfgInput" accept=".json" style="display: none;">
                        <button class="btn-card" onclick="document.getElementById('levelCfgInput').click()">ğŸ“‚
                            æœ¬åœ°åŠ è½½</button>
                        <button class="btn-card" id="btnRemoteLevelLoad" onclick="loadRemoteLevelConfig()">â˜ï¸
                            ç½‘ç»œåŠ è½½</button>
                    </div>
                </div>
            </div>

            <!-- Configuration Set Controls (V7.14 Redesign) -->
            <div id="configControls"
                style="background:#fff3e0; padding:15px; border-radius:8px; margin-bottom:10px; border:1px solid #ffe0b2;">

                <!-- Row 1: Title & Actions -->
                <div
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; border-bottom:1px solid #ffcc80; padding-bottom:5px;">
                    <h3 style="margin:0; color:#e65100; font-size:1.1em;">ğŸ”§ é…ç½®é›†ç®¡ç† (Config Set Manager)</h3>
                    <div>
                        <button class="btn btn-outline" onclick="showMappingModal()"
                            style="border-color:#e65100; color:#e65100; font-size:0.9em; padding:4px 8px;">ğŸŒ
                            åœ°åŒºæ˜ å°„</button>
                        <button class="btn btn-outline" onclick="showConfigSetModal()"
                            style="border-color:#8e44ad; color:#8e44ad; font-size:0.9em; padding:4px 8px;">ğŸ”¨
                            ç®¡ç†é…ç½®é›†</button>
                    </div>
                </div>

                <!-- Row 2: Selectors -->
                <div style="display:flex; gap:20px;">
                    <div style="flex:1;">
                        <label for="configKeySelect"
                            style="display:block; font-size:0.9em; color:#666; margin-bottom:4px;">å½“å‰é…ç½®é›† (Config
                            Key):</label>
                        <select id="configKeySelect" style="width:100%; padding:5px;"
                            onchange="loadSelectedConfigKey()"></select>
                    </div>
                    <div style="flex:1;" id="idSelectorContainer">
                        <label for="idSelect"
                            style="display:block; font-size:0.9em; color:#666; margin-bottom:4px;">é€‰æ‹©é…ç½®é¡¹ ID (Select
                            ID):</label>
                        <select id="idSelect" style="width:100%; padding:5px;" onchange="loadSelectedSeries()"></select>
                    </div>
                </div>
            </div>

            <div id="editorArea" class="editor-area">



                <div style="display: flex; gap: 20px;">
                    <div class="form-group" style="flex: 1;">
                        <label>Order (æ’åº):</label>
                        <input type="number" id="orderInput" onchange="updateCurrentData()">
                    </div>
                    <div class="form-group" style="flex: 2;">
                        <label>Img (å›¾ç‰‡å):</label>
                        <input type="text" id="imgInput" onchange="updateCurrentData()">
                    </div>
                </div>

                <div class="form-group">
                    <div class="levels-header">
                        <label style="margin:0; font-size:1.1em;">Levels åˆ—è¡¨é…ç½®:</label>
                        <button class="btn btn-outline" onclick="toggleBulkEdit()">âœ æ‰¹é‡ç¼–è¾‘ / å¯¼å…¥ (Bulk Edit)</button>
                    </div>

                    <div id="normalView" class="levels-wrapper">
                        <div id="levelsList" class="levels-container"></div>
                        <button class="btn"
                            style="width:100%; background:#fff; border:2px dashed #ddd; color:#666; margin-top:5px;"
                            onclick="addNewLevel()">+ æ–°å¢ä¸€é¡¹ (Add Level)</button>
                    </div>

                    <div id="bulkView" class="bulk-edit-area">
                        <div style="margin-bottom:8px; color:#555;">è¯·åœ¨ä¸‹æ–¹ç²˜è´´æ–°çš„ Levels ID åˆ—è¡¨ï¼ˆæ”¯æŒé€—å·åˆ†éš”æˆ–æ¢è¡Œï¼‰ï¼š</div>

                        <textarea id="bulkTextarea" placeholder="ä¾‹å¦‚: s200, s201, s202..."></textarea>

                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="overwriteCheckbox">
                            <label for="overwriteCheckbox">
                                <strong>è¦†ç›–ç°æœ‰åˆ—è¡¨ (Overwrite Mode)</strong>
                                <span class="checkbox-note">
                                    ğŸ”² <strong>ä¸é€‰ä¸­ (æ¨è)</strong>:
                                    æ–°ç²˜è´´çš„æ•°æ®ä¼šæ’åœ¨<strong>æœ€å‰é¢</strong>ï¼Œæ—§åˆ—è¡¨ä¸­å‰©ä½™çš„æ•°æ®ä¼šè‡ªåŠ¨è·Ÿåœ¨åé¢ï¼ˆä¸ä¸¢å¤±æ•°æ®ï¼‰ã€‚<br>
                                    âœ… <strong>é€‰ä¸­</strong>: <strong>å®Œå…¨åˆ é™¤</strong>æ—§åˆ—è¡¨ï¼Œåªä¿ç•™ä¸Šæ–¹æ–‡æœ¬æ¡†ä¸­çš„å†…å®¹ã€‚
                                </span>
                            </label>
                        </div>

                        <div class="bulk-actions">
                            <button class="btn btn-outline" style="margin-right:auto;"
                                onclick="copyCurrentToBulk()">åŠ è½½å½“å‰åˆ—è¡¨</button>
                            <button class="btn" onclick="toggleBulkEdit()">å–æ¶ˆ</button>
                            <button class="btn btn-success" onclick="applyBulkChanges()">åº”ç”¨ä¿®æ”¹</button>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div id="wikiModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeWiki()">&times;</span>
                <h2 style="margin-top:0; color:#2c3e50; border-bottom:1px solid #ddd; padding-bottom:15px;">ğŸ“– å·¥å…·ä½¿ç”¨æ•™ç¨‹
                    (Wiki)
                </h2>

                <div class="wiki-section">
                    <h3>1. åŸºç¡€æ“ä½œ</h3>
                    <ul>
                        <li><strong>Series Config åŠ è½½</strong>ï¼šç‚¹å‡» <span class="wiki-tag">ğŸ“‚æœ¬åœ°åŠ è½½</span> æˆ– <span
                                class="wiki-tag">â˜ï¸ç½‘ç»œåŠ è½½</span> åŠ è½½ä¸»é…ç½®æ–‡ä»¶ã€‚</li>
                        <li><strong>Level Config åŠ è½½</strong>ï¼šç‚¹å‡» <span class="wiki-tag"
                                style="color:#d35400;">ğŸ“‚æœ¬åœ°åŠ è½½</span> æˆ– <span class="wiki-tag">â˜ï¸ç½‘ç»œåŠ è½½</span>
                            ä¸Šä¼ å…³å¡è¯¦æƒ…é…ç½®ã€‚åŠ è½½æˆåŠŸåï¼Œåˆ—è¡¨ä¼šæ˜¾ç¤ºæ¸¸æˆåç§°å¹¶æä¾›è¯¦æƒ…æŸ¥çœ‹åŠŸèƒ½ã€‚</li>
                        <li><strong>é…ç½®é›†ç®¡ç†</strong>ï¼šæ”¯æŒå¤šé…ç½®é›† (base_global, base_us ç­‰)ï¼Œå¯é€šè¿‡ä¸‹æ‹‰èœå•åˆ‡æ¢ï¼Œæ”¯æŒæ–°å»ºã€å¤åˆ¶ã€é‡å‘½åã€åˆ é™¤é…ç½®é›†ã€‚</li>
                        <li><strong>åœ°åŒºæ˜ å°„</strong>ï¼šè®¾ç½®ä¸åŒåœ°åŒº (Locale) ä½¿ç”¨å“ªå¥—é…ç½®ï¼Œä¾‹å¦‚ US -> base_usï¼ŒCN -> base_cnã€‚</li>
                    </ul>
                </div>

                <div class="wiki-section">
                    <h3>2. Series ç¼–è¾‘åŠŸèƒ½</h3>
                    <ul>
                        <li><strong>é€‰æ‹© Series</strong>ï¼šåœ¨ ID é€‰æ‹©å™¨ä¸­åˆ‡æ¢ä¸åŒçš„ Series ID (xl1, xl2 ç­‰) è¿›è¡Œç¼–è¾‘ã€‚</li>
                        <li><strong>åŸºæœ¬å±æ€§</strong>ï¼šç¼–è¾‘ Order (æ’åº) å’Œ Img (å›¾ç‰‡å) å­—æ®µã€‚</li>
                        <li><strong>æ–°å¢/åˆ é™¤ Series</strong>ï¼šé€šè¿‡ç›¸åº”æŒ‰é’®æ·»åŠ æ–°çš„ Series æˆ–åˆ é™¤å½“å‰é€‰ä¸­çš„ Seriesã€‚</li>
                        <li><strong>å†²çªæ£€æµ‹</strong>ï¼šè‡ªåŠ¨æ£€æµ‹å¹¶æ˜¾ç¤ºé‡å¤çš„ IDï¼Œç”¨ "(âŒå†²çª)" æ ‡è®°ã€‚</li>
                    </ul>
                </div>

                <div class="wiki-section">
                    <h3>3. Levels åˆ—è¡¨ç®¡ç†</h3>
                    <ul>
                        <li><strong>æ’åº</strong>ï¼šæ”¯æŒé¼ æ ‡æ‹–æ‹½é‡æ–°æ’åºï¼Œæˆ–ä½¿ç”¨å³ä¾§çš„ â†‘â†“ æŒ‰é’®ç§»åŠ¨ã€‚</li>
                        <li><strong>æŸ¥çœ‹è¯¦æƒ…</strong>ï¼šå¦‚æœåŠ è½½äº† LevelCfgï¼Œç‚¹å‡»åˆ—è¡¨é¡¹å³ä¾§çš„ <span class="wiki-tag">â„¹ï¸</span> å›¾æ ‡å¯æŸ¥çœ‹è¯¥å…³å¡çš„å®Œæ•´
                            JSON ä¿¡æ¯ï¼ˆPath, Stages, Rule ç­‰ï¼‰ã€‚</li>
                        <li><strong>æ–°å¢å…³å¡</strong>ï¼šç‚¹å‡» "+ æ–°å¢ä¸€é¡¹" æŒ‰é’®ï¼Œæ”¯æŒå•ä¸ªæˆ–æ‰¹é‡æ·»åŠ ï¼ˆé€—å·åˆ†éš”ï¼‰ã€‚</li>
                        <li><strong>åˆ é™¤å…³å¡</strong>ï¼šç‚¹å‡»å³ä¾§çš„ âœ• æŒ‰é’®åˆ é™¤æŒ‡å®šé¡¹ã€‚</li>
                        <li><strong>æ¸¸æˆåç§°æ˜¾ç¤º</strong>ï¼šåŠ è½½ LevelCfg åï¼Œåˆ—è¡¨ä¼šæ˜¾ç¤ºå…³å¡å¯¹åº”çš„æ¸¸æˆåç§°ã€‚</li>
                    </ul>
                </div>

                <div class="wiki-section">
                    <h3>4. æ‰¹é‡ç¼–è¾‘ (Bulk Edit)</h3>
                    <ul>
                        <li><strong>æ‰¹é‡å¯¼å…¥</strong>ï¼šæ”¯æŒä» Excel æˆ–æ–‡æœ¬ä¸­ç²˜è´´ ID åˆ—è¡¨ï¼ˆæ”¯æŒé€—å·ã€æ¢è¡Œåˆ†éš”ï¼‰ã€‚</li>
                        <li><strong>æ™ºèƒ½åˆå¹¶</strong>ï¼šé»˜è®¤æ¨¡å¼å°†æ–° ID ç½®é¡¶ï¼Œæ—§ ID è‡ªåŠ¨é¡ºå»¶ï¼Œé¿å…æ•°æ®ä¸¢å¤±ã€‚</li>
                        <li><strong>è¦†ç›–æ¨¡å¼</strong>ï¼šå‹¾é€‰ "è¦†ç›–ç°æœ‰åˆ—è¡¨" åï¼Œå®Œå…¨æ›¿æ¢ç°æœ‰åˆ—è¡¨ã€‚</li>
                        <li><strong>åŠ è½½å½“å‰åˆ—è¡¨</strong>ï¼šç‚¹å‡» "åŠ è½½å½“å‰åˆ—è¡¨" å¯å°†ç°æœ‰æ•°æ®å¡«å……åˆ°ç¼–è¾‘æ¡†ä¸­ã€‚</li>
                    </ul>
                </div>

                <div class="wiki-section">
                    <h3>5. äº‘ç«¯åŠŸèƒ½</h3>
                    <ul>
                        <li><strong>ç½‘ç»œåŠ è½½</strong>ï¼šé€šè¿‡ Cloudflare Worker ä»è¿œç¨‹ Gist åŠ è½½é…ç½®æ–‡ä»¶ã€‚</li>
                        <li><strong>ä¿å­˜åˆ°ç½‘ç»œ</strong>ï¼šç¼–è¾‘å®Œæˆåå¯ä¿å­˜åˆ°è¿œç¨‹ Gistï¼Œæ”¯æŒè‡ªåŠ¨é“¾å¼åŠ è½½ SeriesCfg å’Œ LevelCfgã€‚</li>
                        <li><strong>è®¾ç½®ç®¡ç†</strong>ï¼šé¦–æ¬¡ä½¿ç”¨æ—¶éœ€è¦é…ç½® Worker URL å’Œè®¿é—®å¯†ç ã€‚</li>
                        <li><strong>çŠ¶æ€æŒ‡ç¤º</strong>ï¼šé€šè¿‡é¢œè‰²çŠ¶æ€ç‚¹æ˜¾ç¤ºæœ¬åœ°/è¿œç¨‹åŠ è½½çŠ¶æ€ï¼ˆç»¿è‰²=æˆåŠŸï¼Œçº¢è‰²=å¤±è´¥ï¼‰ã€‚</li>
                    </ul>
                </div>

                <div class="wiki-section">
                    <h3>6. æ•°æ®ç®¡ç†</h3>
                    <ul>
                        <li><strong>å¯¼å‡º JSON</strong>ï¼šç‚¹å‡» "ğŸ“¤ å¯¼å‡º JSON" ä¸‹è½½å®Œæ•´çš„é…ç½®æ–‡ä»¶ã€‚</li>
                        <li><strong>å¤åˆ¶ JSON</strong>ï¼šç‚¹å‡» "ğŸ“‹ å¤åˆ¶" å°†å®Œæ•´é…ç½®å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚</li>
                        <li><strong>æ ¼å¼å…¼å®¹</strong>ï¼šè‡ªåŠ¨æ£€æµ‹å¹¶è½¬æ¢æ—§ç‰ˆæ•°ç»„æ ¼å¼åˆ°æ–°ç‰ˆç»“æ„ (configs + mapping)ã€‚</li>
                        <li><strong>æœªä¿å­˜æé†’</strong>ï¼šæœ‰æœªä¿å­˜ä¿®æ”¹æ—¶ï¼Œæ ‡é¢˜æ æ˜¾ç¤º "*" å·ï¼Œå…³é—­é¡µé¢æ—¶ä¼šæé†’ä¿å­˜ã€‚</li>
                    </ul>
                </div>

                <div class="wiki-section">
                    <h3>7. ç•Œé¢ç‰¹æ€§</h3>
                    <ul>
                        <li><strong>ç²˜æ€§å·¥å…·æ </strong>ï¼šæ»šåŠ¨æ—¶å·¥å…·æ è‡ªåŠ¨å¸é™„é¡¶éƒ¨ï¼Œæ–¹ä¾¿æ“ä½œã€‚</li>
                        <li><strong>å¡ç‰‡å¼å¸ƒå±€</strong>ï¼šSeries Config å’Œ Level Config é‡‡ç”¨å¡ç‰‡è®¾è®¡ï¼ŒçŠ¶æ€æ¸…æ™°ã€‚</li>
                        <li><strong>å“åº”å¼è®¾è®¡</strong>ï¼šé€‚é…ä¸åŒå±å¹•å°ºå¯¸ï¼Œæ”¯æŒç§»åŠ¨ç«¯æ“ä½œã€‚</li>
                        <li><strong>å›åˆ°é¡¶éƒ¨</strong>ï¼šæ»šåŠ¨è¶…è¿‡ 300px æ—¶æ˜¾ç¤ºæµ®åŠ¨æŒ‰é’®ã€‚</li>
                    </ul>
                </div>

                <div style="text-align: right;">
                    <button class="btn" onclick="closeWiki()">æˆ‘æ˜ç™½äº†</button>
                </div>
            </div>
        </div>

        <div id="detailModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeDetailModal()">&times;</span>
                <h2 id="detailTitle" style="margin-top:0; color:#2c3e50; padding-bottom:10px;">å…³å¡è¯¦æƒ…</h2>
                <pre id="detailContent" class="json-display"></pre>
                <div style="text-align: right; margin-top:15px;">
                    <button class="btn" onclick="closeDetailModal()">å…³é—­</button>
                </div>
            </div>
        </div>

        <div id="mappingModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeMappingModal()">&times;</span>
                <h2 style="margin-top:0; color:#2c3e50;">ğŸŒ åœ°åŒºæ˜ å°„ç®¡ç† (Locale Mapping)</h2>
                <p style="color:#666; margin-bottom:15px;">è®¾ç½®ä¸åŒåœ°åŒº (Locale) ä½¿ç”¨å“ªå¥—é…ç½® (Config Key)ã€‚ä¾‹å¦‚ US -> base_usã€‚</p>

                <div style="margin-bottom: 20px;">
                    <table style="width:100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background:#f4f6f8; text-align:left;">
                                <th style="padding:10px; border-bottom:2px solid #ddd;">åœ°åŒº (Locale)</th>
                                <th style="padding:10px; border-bottom:2px solid #ddd;">æŒ‡å‘çš„é…ç½®é›† (Config Key)</th>
                                <th style="padding:10px; border-bottom:2px solid #ddd;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="mappingTableBody">
                            <!-- Mapping rows go here -->
                        </tbody>
                    </table>
                </div>

                <div style="background:#fafafa; padding:15px; border-radius:6px; border:1px dashed #ddd;">
                    <strong>æ–°å¢æ˜ å°„:</strong>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <input type="text" id="newLocaleInput" placeholder="Locale (e.g. CN, KR)" style="flex:1;">
                        <select id="newMapKeySelect" style="flex:1;"></select>
                        <button class="btn btn-success" onclick="addNewMapping()">+ æ·»åŠ </button>
                    </div>
                </div>

                <div style="text-align: right; margin-top:20px;">
                    <button class="btn" onclick="closeMappingModal()">å…³é—­</button>
                </div>
            </div>
        </div>

        <div id="configSetModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeConfigSetModal()">&times;</span>
                <h2 style="margin-top:0; color:#2c3e50;">ğŸ”§ é…ç½®é›†ç®¡ç† (Config Sets)</h2>
                <p style="color:#666; margin-bottom:15px;">æ–°å»ºã€å¤åˆ¶æˆ–é‡å‘½åé…ç½®é›†ã€‚é‡å‘½åä¼šè‡ªåŠ¨æ›´æ–°å…³è”çš„æ˜ å°„ã€‚</p>

                <div style="margin-bottom: 20px;">
                    <table style="width:100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background:#f4f6f8; text-align:left;">
                                <th style="padding:10px; border-bottom:2px solid #ddd;">é…ç½®é›†åç§° (Key)</th>
                                <th style="padding:10px; border-bottom:2px solid #ddd;">åŒ…å« Series æ•°é‡</th>
                                <th style="padding:10px; border-bottom:2px solid #ddd;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="configSetTableBody">
                            <!-- Rows -->
                        </tbody>
                    </table>
                </div>

                <div
                    style="background:#fafafa; padding:15px; border-radius:6px; border:1px dashed #ddd; display:flex; gap:10px;">
                    <button class="btn btn-outline" onclick="addNewConfigSet(true)">+ æ–°å»ºç©ºé…ç½® (Empty)</button>
                    <button class="btn btn-outline" onclick="duplicateConfigSet(true)">+ å¤åˆ¶å½“å‰å‡ (Copy Current)</button>
                </div>

                <div style="text-align: right; margin-top:20px;">
                    <button class="btn" onclick="closeConfigSetModal()">å…³é—­</button>
                </div>
            </div>
        </div>

        <button onclick="scrollToTop()" id="backToTopBtn" class="fab-top" title="å›åˆ°é¡¶éƒ¨">â¬†ï¸</button>

        <script>
            // --- Version Control ---
            const APP_VERSION = "V7.16";
            document.getElementById('appVersion').textContent = APP_VERSION;

            // --- Unsaved Changes Protection ---
            let hasUnsavedChanges = false;

            function markUnsaved() {
                if (!hasUnsavedChanges) {
                    hasUnsavedChanges = true;
                    document.title = "* " + document.title;
                    document.getElementById('saveRemoteBtn').classList.add('pulse-anim'); // Optional visual cue
                }
            }

            function markSaved() {
                hasUnsavedChanges = false;
                if (document.title.startsWith("* ")) {
                    document.title = document.title.substring(2);
                }
                document.getElementById('saveRemoteBtn').classList.remove('pulse-anim');
            }

            window.addEventListener('beforeunload', function (e) {
                if (hasUnsavedChanges) {
                    // Standard way to trigger browser prompt
                    e.preventDefault();
                    e.returnValue = '';
                }
            });

            // --- Cloudflare Worker Settings ---
            let workerConfig = {
                url: localStorage.getItem("cf_worker_url") || "",
                pwd: localStorage.getItem("cf_worker_pwd") || ""
            };

            function showOnlineSettings() {
                const url = prompt("è¯·è¾“å…¥ Cloudflare Worker URL (e.g. https://your-worker.workers.dev):", workerConfig.url);
                if (url !== null) {
                    const pwd = prompt("è¯·è¾“å…¥è®¿é—®å¯†ç  (Access Password):", workerConfig.pwd);
                    if (pwd !== null) {
                        workerConfig.url = url.trim();
                        workerConfig.pwd = pwd.trim();
                        localStorage.setItem("cf_worker_url", workerConfig.url);
                        localStorage.setItem("cf_worker_pwd", workerConfig.pwd);
                        alert("è®¾ç½®å·²ä¿å­˜ï¼èƒ½å¤Ÿå°è¯•â€œä»ç½‘ç»œåŠ è½½â€å’Œâ€œä¿å­˜åˆ°ç½‘ç»œâ€äº†ã€‚");

                    }
                }
            }

            async function loadRemoteSeriesConfig() {
                if (!workerConfig.url) {
                    showOnlineSettings();
                    if (!workerConfig.url) return;
                }

                // Auto-load using Worker (No more Gist Raw URL prompt)
                const btnLevelRemote = document.getElementById('btnRemoteLevelLoad');
                const btnLevelLocal = document.querySelector("#levelCfgInput + button");

                try {
                    // Lock Level Buttons Immediately
                    if (btnLevelRemote) btnLevelRemote.disabled = true;
                    if (btnLevelLocal) btnLevelLocal.disabled = true;

                    const infoEl = document.getElementById('seriesPathDisplay');
                    infoEl.textContent = "SeriesCfg: [Downloading...]";
                    document.getElementById('seriesStatusDot').className = 'status-dot';

                    // Use the new GET endpoint on the worker
                    const resp = await fetch(workerConfig.url, {
                        method: "GET",
                        headers: {
                            "X-Auth-Password": workerConfig.pwd, // Still protected
                            "Accept": "application/json"
                        }
                    });

                    if (!resp.ok) {
                        const errText = await resp.text();
                        throw new Error(`Worker Error (${resp.status}): ${errText}`);
                    }

                    const raw = await resp.json();

                    // Same parsing logic as file input
                    if (Array.isArray(raw)) {
                        fullConfigData = {
                            configs: { "base_global": raw },
                            mapping: { "default": "base_global" }
                        };
                    } else if (raw.configs && raw.mapping) {
                        fullConfigData = raw;
                    } else {
                        throw new Error("æ— æ³•è¯†åˆ«çš„ JSON ç»“æ„: " + JSON.stringify(raw).substring(0, 50));
                    }


                    initConfigKeySelector();

                    // Update New File Info Display
                    const displayEl = document.getElementById('seriesPathDisplay');
                    displayEl.textContent = "[Remote] Gist (Worker)"; // Match mockup-ish
                    displayEl.title = "å·²åŠ è½½è¿œç¨‹é…ç½®";
                    document.getElementById('seriesStatusDot').className = 'status-dot active remote';

                    document.getElementById('exportBtn').disabled = false;
                    document.getElementById('copyBtn').disabled = false;
                    document.getElementById('editorArea').style.display = 'block';
                    document.getElementById('idSelectorContainer').style.display = 'block';

                    alert("è¿œç¨‹é…ç½® SeriesCfg åŠ è½½æˆåŠŸï¼æ­£åœ¨å°è¯•åŠ è½½ LevelCfg...");
                    markSaved();

                    // Chain Load
                    loadRemoteLevelConfig();


                } catch (err) {
                    console.error(err);
                    alert("åŠ è½½å¤±è´¥: " + err.message);
                    const displayEl = document.getElementById('seriesPathDisplay');
                    displayEl.textContent = "SeriesCfg: (åŠ è½½å¤±è´¥)";
                    displayEl.style.color = "red";
                    document.getElementById('seriesStatusDot').className = 'status-dot error';

                    // Unlock Level Buttons on Series Error (since Chain won't happen)
                    if (btnLevelRemote) btnLevelRemote.disabled = false;
                    if (btnLevelLocal) btnLevelLocal.disabled = false;
                }
            }

            async function loadRemoteLevelConfig() {
                if (!workerConfig.url || !workerConfig.pwd) return;

                const btn = document.getElementById('btnRemoteLevelLoad');
                const infoEl = document.getElementById('levelPathDisplay');
                const statusDot = document.getElementById('levelStatusDot');

                try {
                    // Locks
                    const otherBtn = document.querySelector("#levelCfgInput + button"); // Local Load Btn
                    btn.disabled = true;
                    btn.textContent = "Loading...";
                    if (otherBtn) otherBtn.disabled = true;

                    infoEl.textContent = "LevelCfg: [Downloading...]";
                    statusDot.className = 'status-dot';

                    const urlObj = new URL(workerConfig.url);
                    urlObj.searchParams.set("file", "LevelCfg.json");

                    const resp = await fetch(urlObj.toString(), {
                        method: "GET",
                        headers: { "X-Auth-Password": workerConfig.pwd }
                    });

                    if (!resp.ok) {
                        // Likely file doesn't exist yet, which is fine
                        throw new Error(resp.status === 500 ? "File Not Found or Error" : resp.statusText);
                    }

                    const raw = await resp.json();
                    if (Array.isArray(raw)) {
                        levelConfigMap = {};
                        raw.forEach(item => { if (item.ID) levelConfigMap[item.ID] = item; });
                        if (currentSeriesIndex !== -1) renderLevelsList();

                        infoEl.textContent = "[Remote] Gist (LevelCfg)";
                        infoEl.title = "å·²åŠ è½½è¿œç¨‹ Levelé…ç½®";
                        statusDot.className = 'status-dot active remote';
                        alert("âœ… è¿œç¨‹ Level é…ç½®åŠ è½½æˆåŠŸï¼");
                    } else {
                        throw new Error("æ ¼å¼é”™è¯¯: éæ•°ç»„");
                    }

                } catch (err) {
                    console.warn("Remote Level Load:", err);
                    infoEl.textContent = "LevelCfg: (æœªæ‰¾åˆ°æˆ–åŠ è½½å¤±è´¥)";
                    statusDot.className = 'status-dot error';
                    // Optional: Don't alert if it's just missing, to avoid annoyance? 
                    // User asked for function, so alert is probably better or console. 
                    // Let's stick to console warn + UI status update for now to avoid blocking flow
                } finally {
                    // Unlocks
                    btn.disabled = false;
                    btn.textContent = "â˜ï¸ ç½‘ç»œåŠ è½½";
                    const otherBtn = document.querySelector("#levelCfgInput + button");
                    if (otherBtn) otherBtn.disabled = false;
                }
            }

            async function saveToRemote() {
                if (!workerConfig.url || !workerConfig.pwd) {
                    showOnlineSettings();
                    if (!workerConfig.url || !workerConfig.pwd) return;
                }

                if (!confirm("âš ï¸ ç¡®å®šè¦ä¿å­˜ä¿®æ”¹åˆ°è¿œç¨‹ Gist å—ï¼Ÿè¿™å°†ç›´æ¥å½±å“çº¿ä¸Šé…ç½®ï¼")) return;

                const btn = document.getElementById('saveRemoteBtn');
                const originalText = btn.textContent;
                btn.textContent = "Saving...";
                btn.disabled = true;

                try {
                    // Construct the Gist payload
                    const payload = {
                        files: {
                            "SeriesLocaleCfg.json": {
                                content: JSON.stringify(fullConfigData, null, 2)
                            }
                        }
                    };

                    const resp = await fetch(workerConfig.url, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-Auth-Password": workerConfig.pwd
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!resp.ok) {
                        const errText = await resp.text();
                        throw new Error(`Server Error (${resp.status}): ${errText}`);
                    }

                    const resJson = await resp.json();
                    console.log("Save Response:", resJson);

                    alert("âœ… ä¿å­˜æˆåŠŸï¼Gist å·²æ›´æ–°ã€‚");
                    markSaved();

                } catch (err) {
                    alert("âŒ ä¿å­˜å¤±è´¥: " + err.message);
                } finally {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            }

            // Data Structure:
            // fullConfigData = { 
            //    configs: { "base_global": [...], "base_us": [...] }, 
            //    mapping: { "default": "base_global", "US": "base_us" } 
            // }
            let fullConfigData = { configs: {}, mapping: {} };

            // Current Context
            let currentConfigKey = "";
            let jsonData = []; // Points to fullConfigData.configs[currentConfigKey]

            let levelConfigMap = {};
            let currentSeriesIndex = -1;

            // --- File Loading: SeriesCfg ---
            document.getElementById('fileInput').addEventListener('change', function (event) {
                const file = event.target.files[0];
                if (!file) return;

                // Update Display
                const displayPath = file.path || file.name; // file.path works in Electron/some envs
                const displayEl = document.getElementById('seriesPathDisplay');
                displayEl.textContent = "[Local] " + displayPath;
                displayEl.title = displayPath;
                displayEl.style.color = ""; // Reset error red
                document.getElementById('seriesStatusDot').className = 'status-dot active';

                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const raw = JSON.parse(e.target.result);

                        // 1. Data Migration / Detection
                        if (Array.isArray(raw)) {
                            // Legacy Array Format -> Convert to New Structure
                            fullConfigData = {
                                configs: { "base_global": raw },
                                mapping: { "default": "base_global" }
                            };
                            alert("âš ï¸ æ£€æµ‹åˆ°æ—§ç‰ˆæ ¼å¼ï¼Œå·²è‡ªåŠ¨è½¬æ¢ä¸ºæ–°ç‰ˆç»“æ„ (base_global)ã€‚");
                        } else if (raw.configs && raw.mapping) {
                            // New Format
                            fullConfigData = raw;
                        } else {
                            throw new Error("æ— æ³•è¯†åˆ«çš„ JSON ç»“æ„");
                        }

                        // 2. Initialize UI
                        initConfigKeySelector();
                        // Removed old status element update

                        document.getElementById('exportBtn').disabled = false;
                        document.getElementById('copyBtn').disabled = false;
                        document.getElementById('editorArea').style.display = 'block';
                        document.getElementById('idSelectorContainer').style.display = 'block';
                        markSaved();
                    } catch (err) { alert('è§£æé”™è¯¯: ' + err.message); }
                };
                reader.readAsText(file);
            });

            // --- File Loading: LevelCfg ---
            document.getElementById('levelCfgInput').addEventListener('change', function (event) {
                const file = event.target.files[0];
                if (!file) return;

                // Update Display
                const displayPath = file.path || file.name;
                const displayEl = document.getElementById('levelPathDisplay');
                displayEl.textContent = "[Local] " + displayPath;
                displayEl.title = displayPath;
                document.getElementById('levelStatusDot').className = 'status-dot active';

                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const cfgData = JSON.parse(e.target.result);
                        levelConfigMap = {};
                        cfgData.forEach(item => { if (item.ID) levelConfigMap[item.ID] = item; });

                        // Removed old status element update
                        if (currentSeriesIndex !== -1) renderLevelsList();
                        alert(`æˆåŠŸåŠ è½½è¯¦æƒ…é…ç½®ï¼åŒ…å« ${cfgData.length} ä¸ªå…³å¡æ•°æ®ã€‚`);
                    } catch (err) { alert('LevelCfg è§£æé”™è¯¯: ' + err.message); }
                };
                reader.readAsText(file);
            });

            // --- Config Key Management ---
            function initConfigKeySelector() {
                // 1. Populate Config Key Select
                const keySelect = document.getElementById('configKeySelect');
                keySelect.innerHTML = '';

                const keys = Object.keys(fullConfigData.configs);
                if (keys.length === 0) {
                    // Should not happen if migrated correctly, but safe guard
                    fullConfigData.configs["base_global"] = [];
                    keys.push("base_global");
                }

                keys.forEach(k => {
                    const opt = document.createElement('option');
                    opt.value = k; opt.text = k;
                    keySelect.appendChild(opt);
                });

                // 2. Initial Selection
                if (!currentConfigKey || !fullConfigData.configs[currentConfigKey]) {
                    currentConfigKey = keys[0];
                }
                keySelect.value = currentConfigKey;

                loadSelectedConfigKey();
            }

            function loadSelectedConfigKey() {
                currentConfigKey = document.getElementById('configKeySelect').value;
                jsonData = fullConfigData.configs[currentConfigKey];

                // Re-init Series Selector for this config set
                initSeriesEditor();
            }

            // --- Config Set Modal Logic ---
            function showConfigSetModal() {
                const tbody = document.getElementById('configSetTableBody');
                tbody.innerHTML = '';

                Object.keys(fullConfigData.configs).forEach(key => {
                    const count = fullConfigData.configs[key].length;
                    const tr = document.createElement('tr');
                    tr.style.borderBottom = "1px solid #eee";
                    tr.innerHTML = `
                    <td style="padding:10px; font-weight:bold; color:#2980b9;">${key}</td>
                    <td style="padding:10px;">${count} Series</td>
                    <td style="padding:10px;">
                        <button class="btn-icon info" style="width:24px; height:24px; margin-right:5px;" onclick="renameConfigSet('${key}')" title="é‡å‘½å (Rename)">âœ</button>
                        <button class="btn-icon delete" style="width:24px; height:24px;" onclick="deleteConfigSetFromModal('${key}')" title="åˆ é™¤ (Delete)">âœ•</button>
                    </td>
                `;
                    tbody.appendChild(tr);
                });

                document.getElementById('configSetModal').style.display = 'block';
            }

            function closeConfigSetModal() {
                document.getElementById('configSetModal').style.display = 'none';
            }

            function addNewConfigSet(fromModal = false) {
                const name = prompt("è¯·è¾“å…¥æ–°é…ç½®é›†åç§° (ä¾‹å¦‚ base_cn):", "base_cn");
                if (!name) return;
                if (fullConfigData.configs[name]) { alert("åç§°å·²å­˜åœ¨"); return; }

                // Clone currently selected data or empty
                // If called from modal, just create empty? Or ask?
                // Let's simplified: Create Empty default, or Copy Current default.
                // The buttons differentiate: "Empty" vs "Copy".

                // Logic for "Empty":
                fullConfigData.configs[name] = [];

                afterConfigActions(name, fromModal);
            }

            function duplicateConfigSet(fromModal = false) {
                const name = prompt(`è¯·è¾“å…¥æ–°é…ç½®é›†åç§° (å¤åˆ¶è‡ª ${currentConfigKey}):`, `${currentConfigKey}_copy`);
                if (!name) return;
                if (fullConfigData.configs[name]) { alert("åç§°å·²å­˜åœ¨"); return; }

                fullConfigData.configs[name] = JSON.parse(JSON.stringify(jsonData));
                afterConfigActions(name, fromModal);
            }

            function afterConfigActions(newName, fromModal) {
                initConfigKeySelector(); // Refresh Main UI
                document.getElementById('configKeySelect').value = newName;
                loadSelectedConfigKey();
                markUnsaved();

                if (fromModal) {
                    showConfigSetModal(); // Refresh Modal UI
                }
            }

            function renameConfigSet(oldKey) {
                const newKey = prompt(`é‡å‘½åé…ç½®é›† [${oldKey}] ä¸º:`, oldKey);
                if (!newKey || newKey === oldKey) return;
                if (fullConfigData.configs[newKey]) { alert("æ–°åç§°å·²å­˜åœ¨ï¼"); return; }

                // 1. Move Data
                fullConfigData.configs[newKey] = fullConfigData.configs[oldKey];
                delete fullConfigData.configs[oldKey];

                // 2. Update Mappings
                let mapUpdated = false;
                for (let loc in fullConfigData.mapping) {
                    if (fullConfigData.mapping[loc] === oldKey) {
                        fullConfigData.mapping[loc] = newKey;
                        mapUpdated = true;
                    }
                }
                if (mapUpdated) {
                    // alert(`å…³è”çš„æ˜ å°„å·²æ›´æ–°ä¸º ${newKey}`);
                }

                // 3. Update Current Key if needed
                if (currentConfigKey === oldKey) {
                    currentConfigKey = newKey;
                }

                initConfigKeySelector();
                document.getElementById('configKeySelect').value = currentConfigKey;
                showConfigSetModal();
                markUnsaved();
            }

            function deleteConfigSetFromModal(key) {
                const keys = Object.keys(fullConfigData.configs);
                if (keys.length <= 1) { alert("å¿…é¡»è‡³å°‘ä¿ç•™ä¸€ä¸ªé…ç½®é›†ï¼"); return; }

                if (!confirm(`ç¡®å®šè¦åˆ é™¤é…ç½®é›† [${key}] å—ï¼Ÿ\nåŒ…å« ${fullConfigData.configs[key].length} ä¸ª Seriesã€‚\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;

                delete fullConfigData.configs[key];

                // Clean Mappings
                for (let loc in fullConfigData.mapping) {
                    if (fullConfigData.mapping[loc] === key) {
                        delete fullConfigData.mapping[loc];
                    }
                }

                // If we deleted the current one, switch to another
                if (currentConfigKey === key) {
                    currentConfigKey = Object.keys(fullConfigData.configs)[0];
                }

                initConfigKeySelector();
                document.getElementById('configKeySelect').value = currentConfigKey;
                loadSelectedConfigKey();

                showConfigSetModal();
                markUnsaved();
            }

            // Removed old deleteConfigSet fn as it is replaced by modal logic


            // --- Series Editor Logic (Existing adapted) ---
            function initSeriesEditor() {
                const select = document.getElementById('idSelect');
                select.innerHTML = '';

                if (!jsonData || jsonData.length === 0) {
                    // Handle empty config set
                    const opt = document.createElement('option');
                    opt.text = "(æ— æ•°æ® - ç‚¹å‡»æ–°å¢)";
                    select.appendChild(opt);
                    // Disable inputs maybe?
                    currentSeriesIndex = -1;
                    document.getElementById('normalView').style.display = 'none';
                    return;
                }

                // check duplicate ID
                let idMap = {};
                jsonData.forEach((s, i) => {
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.text = s.ID;
                    if (idMap[s.ID]) opt.text += " (âŒå†²çª)";
                    idMap[s.ID] = true;
                    select.appendChild(opt);
                });

                select.value = 0;
                loadSelectedSeries();
            }

            function loadSelectedSeries() {
                const select = document.getElementById('idSelect');
                if (jsonData.length === 0) return;

                currentSeriesIndex = parseInt(select.value);
                const data = jsonData[currentSeriesIndex];

                document.getElementById('orderInput').value = data.Order;
                document.getElementById('imgInput').value = data.Img;

                document.getElementById('normalView').style.display = 'block';
                document.getElementById('bulkView').style.display = 'none';
                document.getElementById('overwriteCheckbox').checked = false;
                document.getElementById('bulkTextarea').value = "";

                renderLevelsList();
            }

            function addNewSeries() {
                const id = prompt("è¯·è¾“å…¥æ–°çš„ ID (å¦‚ xl100):");
                if (!id) return;

                // Check if ID exists in current config
                if (jsonData.some(item => item.ID === id)) {
                    alert("ID å·²å­˜åœ¨ï¼");
                    return;
                }

                jsonData.push({
                    "ID": id,
                    "Order": jsonData.length,
                    "Img": "",
                    "Levels": []
                });

                initSeriesEditor();
                // Select the new one
                const select = document.getElementById('idSelect');
                select.value = jsonData.length - 1;
                loadSelectedSeries();
                markUnsaved();
            }

            function removeSeries() {
                if (currentSeriesIndex === -1) return;
                if (confirm(`ç¡®å®šåˆ é™¤ ${jsonData[currentSeriesIndex].ID} å—ï¼Ÿ`)) {
                    jsonData.splice(currentSeriesIndex, 1);
                    initSeriesEditor();
                    markUnsaved();
                }
            }

            function updateCurrentData() {
                if (currentSeriesIndex === -1) return;
                jsonData[currentSeriesIndex].Order = parseInt(document.getElementById('orderInput').value);
                jsonData[currentSeriesIndex].Img = document.getElementById('imgInput').value;
                markUnsaved();
            }

            function renderLevelsList() {
                if (!jsonData[currentSeriesIndex]) return;
                const levels = jsonData[currentSeriesIndex].Levels;
                const container = document.getElementById('levelsList');
                container.innerHTML = '';

                levels.forEach((id, idx) => {
                    const detail = levelConfigMap[id];
                    const displayName = detail ? detail.Name : '';
                    const hasDetail = !!detail;

                    const el = document.createElement('div');
                    el.className = 'level-item';
                    el.dataset.index = idx;

                    el.innerHTML = `
                    <div class="level-content" draggable="true">
                        <span class="level-index">${idx + 1}</span>
                        <div class="level-text-group">
                            <span class="level-id">${id}</span>
                            ${displayName ? `<span class="level-name">${displayName}</span>` : ''}
                        </div>
                    </div>
                    <div class="level-actions">
                        ${hasDetail ? `<button class="btn-icon info" onclick="showDetailModal('${id}')" title="æŸ¥çœ‹è¯¦æƒ…">â„¹ï¸</button>` : ''}
                        <button class="btn-icon" onclick="moveItem(${idx}, -1)" title="ä¸Šç§»">â†‘</button>
                        <button class="btn-icon" onclick="moveItem(${idx}, 1)" title="ä¸‹ç§»">â†“</button>
                        <button class="btn-icon delete" onclick="deleteItem(${idx})" title="åˆ é™¤">âœ•</button>
                    </div>
                `;
                    el.addEventListener('dragstart', handleDragStart);
                    el.addEventListener('dragover', handleDragOver);
                    el.addEventListener('drop', handleDrop);
                    el.addEventListener('dragend', handleDragEnd);
                    container.appendChild(el);
                });
            }

            function moveItem(idx, dir) {
                const levels = jsonData[currentSeriesIndex].Levels;
                const target = idx + dir;
                if (target >= 0 && target < levels.length) {
                    [levels[idx], levels[target]] = [levels[target], levels[idx]];
                    renderLevelsList();
                    markUnsaved();
                }
            }
            function deleteItem(idx) {
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™é¡¹å—ï¼Ÿ')) {
                    jsonData[currentSeriesIndex].Levels.splice(idx, 1);
                    renderLevelsList();
                    markUnsaved();
                }
            }
            function addNewLevel() {
                const id = prompt("è¯·è¾“å…¥æ–°çš„ Level ID:");
                if (id) {
                    const items = id.split(/[,ï¼Œ\s]+/).filter(x => x); // Support multiple add
                    items.forEach(x => jsonData[currentSeriesIndex].Levels.push(x.trim()));
                    renderLevelsList();
                    const c = document.getElementById('levelsList');
                    setTimeout(() => c.scrollTop = c.scrollHeight, 50);
                    markUnsaved();
                }
            }

            // --- Detail Modal ---
            function showDetailModal(id) {
                const data = levelConfigMap[id];
                if (!data) return;
                document.getElementById('detailTitle').textContent = `å…³å¡è¯¦æƒ…: ${id} (${data.Name})`;
                document.getElementById('detailContent').textContent = JSON.stringify(data, null, 2);
                document.getElementById('detailModal').style.display = 'block';
            }
            function closeDetailModal() { document.getElementById('detailModal').style.display = 'none'; }

            // --- Bulk Edit ---
            function toggleBulkEdit() {
                const normalView = document.getElementById('normalView');
                const bulkView = document.getElementById('bulkView');
                if (bulkView.style.display === 'none') {
                    normalView.style.display = 'none';
                    bulkView.style.display = 'block';
                    document.getElementById('bulkTextarea').focus();
                } else {
                    normalView.style.display = 'block';
                    bulkView.style.display = 'none';
                }
            }

            // --- Focus Mode ---
            function toggleFocusMode() {
                const wrapper = document.getElementById('normalView'); // We make the wrapper full screen
                wrapper.classList.toggle('focus-mode');

                // Adjust header visibility or style if needed inside focus mode
                // Since we applied styles to .focus-mode children, it should be fine.

                if (wrapper.classList.contains('focus-mode')) {
                    // Add an explicit close button or header hint if needed
                    // For now, the toggle button is outside the wrapper, which is a problem if wrapper covers it.
                    // WE NEED TO MOVE controls inside or handle the wrapper differently.
                }
            }
            function copyCurrentToBulk() {
                const currentLevels = jsonData[currentSeriesIndex].Levels;
                document.getElementById('bulkTextarea').value = currentLevels.join(', ');
            }
            function applyBulkChanges() {
                const rawText = document.getElementById('bulkTextarea').value;
                const isOverwrite = document.getElementById('overwriteCheckbox').checked;
                const newLevels = rawText.split(/[\n,]+/).map(item => item.trim()).filter(item => item !== "");

                if (newLevels.length === 0 && isOverwrite && !confirm("åˆ—è¡¨ä¸ºç©ºï¼Œç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ Levels å—ï¼Ÿ")) return;

                if (isOverwrite) {
                    jsonData[currentSeriesIndex].Levels = newLevels;
                    alert(`å·²è¦†ç›–ï¼å½“å‰åˆ—è¡¨å…± ${newLevels.length} é¡¹ã€‚`);
                    markUnsaved();
                } else {
                    const currentLevels = jsonData[currentSeriesIndex].Levels;
                    const newItemsSet = new Set(newLevels);
                    const remainingOldItems = currentLevels.filter(item => !newItemsSet.has(item));
                    const finalList = [...newLevels, ...remainingOldItems];
                    jsonData[currentSeriesIndex].Levels = finalList;
                    alert(`å·²åˆå¹¶ï¼`);
                    markUnsaved();
                }
                toggleBulkEdit();
                renderLevelsList();
            }

            // --- Drag & Drop ---
            let dragSrc = null;
            function handleDragStart(e) { dragSrc = this; e.dataTransfer.effectAllowed = 'move'; this.style.opacity = '0.4'; }
            function handleDragOver(e) { if (e.preventDefault) e.preventDefault(); return false; }
            function handleDrop(e) {
                if (e.stopPropagation) e.stopPropagation();
                if (dragSrc !== this) {
                    const oldIdx = parseInt(dragSrc.dataset.index);
                    const newIdx = parseInt(this.dataset.index);
                    const levels = jsonData[currentSeriesIndex].Levels;

                    if (newIdx < 0 || newIdx >= levels.length) return false;
                    if (newIdx !== oldIdx) {
                        const [item] = levels.splice(oldIdx, 1);
                        levels.splice(newIdx, 0, item);
                        renderLevelsList();
                        markUnsaved();
                    }
                }
                return false;
            }
            function handleDragEnd() { this.style.opacity = '1'; }

            // --- Export / Copy ---
            function exportJson() {
                const str = JSON.stringify(fullConfigData, null, 2);
                const blob = new Blob([str], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = "SeriesLocaleCfg.json";
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            }

            async function copyJson() {
                const str = JSON.stringify(fullConfigData, null, 2);
                try {
                    await navigator.clipboard.writeText(str);
                    const btn = document.getElementById('copyBtn');
                    const t = btn.textContent;
                    btn.textContent = "âœ… å·²å¤åˆ¶Full JSON!";
                    btn.classList.add("btn-success");
                    setTimeout(() => { btn.textContent = t; btn.classList.remove("btn-success"); }, 2000);
                } catch (err) { alert("å¤åˆ¶å¤±è´¥: " + err); }
            }

            // --- Mapping Modal ---
            function showMappingModal() {
                const tbody = document.getElementById('mappingTableBody');
                tbody.innerHTML = '';

                // Populate Rows
                for (let locale in fullConfigData.mapping) {
                    const targetKey = fullConfigData.mapping[locale];

                    const tr = document.createElement('tr');
                    tr.style.borderBottom = "1px solid #eee";
                    tr.innerHTML = `
                    <td style="padding:10px; font-family:monospace; font-weight:bold;">${locale}</td>
                    <td style="padding:10px;">
                        <span style="background:#e8f5e9; color:#27ae60; padding:2px 6px; border-radius:4px;">${targetKey}</span>
                    </td>
                    <td style="padding:10px;">
                        <button class="btn-icon info" style="width:24px; height:24px; margin-right:5px;" onclick="editMapping('${locale}')" title="ç¼–è¾‘">âœ</button>
                        <button class="btn-icon delete" style="width:24px; height:24px;" onclick="removeMapping('${locale}')" title="åˆ é™¤">âœ•</button>
                    </td>
                `;
                    tbody.appendChild(tr);
                }

                // Populate Dropdown
                const select = document.getElementById('newMapKeySelect');
                select.innerHTML = '';
                Object.keys(fullConfigData.configs).forEach(k => {
                    const opt = document.createElement('option');
                    opt.value = k; opt.text = k;
                    select.appendChild(opt);
                });

                document.getElementById('mappingModal').style.display = 'block';
            }

            function addNewMapping() {
                const locale = document.getElementById('newLocaleInput').value.trim();
                const target = document.getElementById('newMapKeySelect').value;

                if (!locale || !target) { alert("è¯·å¡«å†™å®Œæ•´"); return; }
                if (fullConfigData.mapping[locale]) {
                    if (!confirm(`${locale} å·²å­˜åœ¨ (å½“å‰å€¼: ${fullConfigData.mapping[locale]})ï¼Œç¡®å®šè¦è¦†ç›–å—ï¼Ÿ`)) {
                        return;
                    }
                }

                fullConfigData.mapping[locale] = target;
                showMappingModal(); // Refresh
                document.getElementById('newLocaleInput').value = '';
                markUnsaved();
            }

            function editMapping(locale) {
                const currentTarget = fullConfigData.mapping[locale];
                // Show a prompt with a dropdown text equivalent? 
                // Since prompt only takes text, we ask user to input the config key exactly.
                // OR simpler: we just delete and add new? 
                // Better: Prompt user to choose from available keys.
                // Since standard prompt is text-only, let's use a small trick: 
                // We just ask user to confirm they want to change it, then we can use a custom simple flow 
                // or just use the "Add" input area to "Edit".

                // ACTUALLY: Let's use a prompt to ask for new Key. 
                // To make it user friendly, we should probably list available keys in the prompt message.
                const keys = Object.keys(fullConfigData.configs).join(', ');
                const newKey = prompt(`æ­£åœ¨ç¼–è¾‘ [${locale}]ã€‚\nå½“å‰æŒ‡å‘: ${currentTarget}\n\nè¯·è¾“å…¥æ–°çš„ç›®æ ‡é…ç½®é›† (å¿…é¡»æ˜¯: ${keys}):`, currentTarget);

                if (newKey && newKey !== currentTarget) {
                    if (!fullConfigData.configs[newKey]) {
                        alert(`é”™è¯¯: é…ç½®é›† "${newKey}" ä¸å­˜åœ¨ã€‚\n\nå¯ç”¨å€¼: ${keys}`);
                        return;
                    }
                    fullConfigData.mapping[locale] = newKey;
                    showMappingModal();
                    markUnsaved();
                }
            }

            function removeMapping(locale) {
                if (locale === 'default') { alert("ä¸èƒ½åˆ é™¤ default æ˜ å°„ï¼"); return; }
                if (confirm(`ç¡®å®šåˆ é™¤ ${locale} çš„æ˜ å°„å—ï¼Ÿ`)) {
                    delete fullConfigData.mapping[locale];
                    showMappingModal();
                    markUnsaved();
                }
            }

            function closeMappingModal() { document.getElementById('mappingModal').style.display = 'none'; }
            function showWiki() { document.getElementById('wikiModal').style.display = 'block'; }
            function closeWiki() { document.getElementById('wikiModal').style.display = 'none'; }

            // --- Back to Top ---
            window.onscroll = function () { scrollFunction() };
            function scrollFunction() {
                const btn = document.getElementById("backToTopBtn");
                if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
                    btn.style.display = "block";
                } else {
                    btn.style.display = "none";
                }
            }
            function scrollToTop() {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            window.onclick = function (event) {
                const wiki = document.getElementById('wikiModal');
                const detail = document.getElementById('detailModal');
                const mapModal = document.getElementById('mappingModal');
                if (event.target == wiki) wiki.style.display = "none";
                if (event.target == detail) detail.style.display = "none";
                if (event.target == mapModal) mapModal.style.display = "none";
            }

            // --- Sticky Header Logic ---
            const stickySentinel = document.createElement('div');
            const stickyHeader = document.getElementById('stickyHeader');
            if (stickyHeader) {
                // Insert sentinel before the header
                stickyHeader.parentNode.insertBefore(stickySentinel, stickyHeader);

                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (!entry.isIntersecting && entry.boundingClientRect.top < 0) {
                            stickyHeader.classList.add('is-stuck');
                            stickyHeader.style.position = 'sticky';
                            stickyHeader.style.top = '0';
                        } else {
                            stickyHeader.classList.remove('is-stuck');
                            stickyHeader.style.position = 'relative';
                        }
                    });
                }, { threshold: [1], rootMargin: '-10px 0px 0px 0px' });

                observer.observe(stickySentinel);
            }
        </script>
</body>

</html>